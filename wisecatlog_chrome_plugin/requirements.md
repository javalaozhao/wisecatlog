# 智能文章目录生成器 - Chrome插件需求文档

## 项目概述

一个智能的Chrome浏览器插件，能够自动分析博客和文章类网页的内容结构，生成可交互的目录导航。支持AI辅助生成目录大纲，提供悬浮和嵌入两种展示模式，提升长文阅读体验。

## 核心功能需求

### 1. 内容分析与目录生成

#### 1.1 自动目录检测
- **基于HTML结构分析**：识别常见的文章容器（article, main, .post, .content等）
- **标题标签识别**：自动提取h1-h6标签作为目录层级
- **语义化识别**：支持识别markdown渲染的标题、结构化内容
- **内容边界检测**：准确识别文章主体区域，排除侧边栏、广告等干扰内容

#### 1.2 AI辅助目录生成
- **大语言模型集成**：支持OpenAI、Claude、Gemini、deepseek、kimi、qwen等主流API
- **用户API密钥管理**：安全存储用户输入的API密钥，本地加密保存
- **智能内容分析**：当页面缺乏明确标题结构时，通过AI分析生成逻辑大纲
- **多语言支持**：支持中文、英文等多语言内容的目录生成

### 2. 目录展示与交互

#### 2.1 展示模式
- **悬浮模式**：
  - 默认显示在页面右侧
  - 可拖拽调整位置
  - 支持收起/展开
  - 透明度调节
  - 响应式设计，适配不同屏幕尺寸

- **嵌入模式**：
  - 将目录嵌入到文章开头或侧边
  - 与页面样式融合
  - 支持收起/展开动画

#### 2.2 交互功能
- **平滑跳转**：点击目录项平滑滚动到对应内容位置
- **当前章节高亮**：根据滚动位置自动高亮当前章节
- **章节预览**：鼠标悬停显示章节内容预览
- **快速导航**：支持键盘快捷键导航
- **目录过滤**：支持搜索过滤目录项

### 3. 用户界面设计

#### 3.1 插件图标与弹出界面
- **浏览器工具栏图标**：
  - 显示当前页面目录状态
  - 点击展开快速操作菜单
  - 右键菜单集成

- **设置面板**：
  - API密钥配置
  - 展示偏好设置
  - 样式自定义选项
  - 快捷键绑定

#### 3.2 目录界面
- **现代化设计**：简洁清晰的视觉风格
- **层级缩进**：通过缩进体现章节层级关系
- **图标系统**：不同层级使用不同图标标识
- **进度指示**：显示阅读进度条
- **主题适配**：支持明暗主题切换

### 4. 技术实现要求

#### 4.1 浏览器兼容性
- **Chrome版本**：支持Chrome 88+
- **Manifest版本**：使用Manifest V3规范
- **跨域处理**：处理CORS限制，支持iframe内嵌页面

#### 4.2 性能优化
- **懒加载**：目录内容按需加载
- **缓存机制**：
  - 本地缓存已分析页面结构
  - 缓存API响应结果
  - 缓存清理策略
- **内存管理**：防止内存泄漏，及时清理无用数据

#### 4.3 安全性
- **内容安全策略**：遵循CSP规范
- **用户数据保护**：API密钥本地加密存储
- **权限最小化**：仅申请必要权限
- **沙箱隔离**：content script与页面隔离

### 5. 配置与个性化

#### 5.1 用户偏好
- **目录深度控制**：设置最大显示的标题层级
- **忽略规则**：自定义忽略特定选择器的内容
- **样式定制**：
  - 字体大小调整
  - 颜色主题选择
  - 间距和边距调节
- **行为设置**：
  - 自动开启/手动触发
  - 动画效果开关
  - 快捷键自定义

#### 5.2 站点适配
- **白名单/黑名单**：自定义启用/禁用站点的规则
- **站点特定配置**：为不同站点保存独立配置
- **用户脚本支持**：支持自定义站点适配脚本

### 6. 扩展功能

#### 6.1 使用限制与付费系统
- **免费额度管理**：
  - 新用户注册赠送10次AI总结功能
  - 使用次数达到50次后触发购买提醒
  - 实时显示剩余使用次数

- **购买系统**：
  - 页面弹出二维码支付界面（支持二维码替换更新）
  - 多种支付场景适配
  - 支付成功自动增加使用次数

- **兑换码系统**：
  - 支持开发者批量生成兑换码
  - 每个兑换码可兑换500次解析机会
  - 兑换码输入界面集成在购买弹窗下方
  - 兑换码验证与激活机制
  - 防刷机制：限制兑换频率和IP

#### 6.2 导出与分享
- **目录导出**：支持导出为markdown、JSON格式
- **分享功能**：生成目录分享链接
- **打印优化**：生成适合打印的目录版本

#### 6.3 高级功能
- **阅读模式**：集成沉浸式阅读模式
- **笔记集成**：与笔记应用的集成接口
- **同步功能**：跨设备同步用户配置和缓存

## 技术架构

### 文件结构
```
smart-toc-extension/
├── manifest.json                 # 插件配置文件
├── background.js                # 后台服务脚本
├── content/
│   ├── content.js              # 内容脚本
│   ├── analyzer.js             # 内容分析器
│   └── renderer.js             # 目录渲染器
├── popup/
│   ├── popup.html              # 弹出界面
│   ├── popup.js                # 弹出界面逻辑
│   └── popup.css               # 弹出界面样式
├── options/
│   ├── options.html            # 设置页面
│   ├── options.js              # 设置页面逻辑
│   └── options.css             # 设置页面样式
├── payment/
│   ├── payment.html            # 购买弹窗界面
│   ├── payment.js              # 购买逻辑处理
│   ├── payment.css             # 购买界面样式
│   └── redeem.js               # 兑换码验证
├── admin/
│   ├── code-generator.html     # 兑换码生成工具
│   ├── code-generator.js       # 批量生成兑换码
│   └── code-validator.js       # 兑换码验证服务
├── styles/
│   ├── toc.css                 # 目录样式
│   ├── payment.css             # 支付相关样式
│   └── themes/                 # 主题样式
├── utils/
│   ├── api.js                  # AI API调用
│   ├── cache.js                # 缓存管理
│   ├── storage.js              # 存储管理
│   ├── usage-tracker.js        # 使用次数统计
│   ├── payment-api.js          # 支付接口
│   └── redemption-system.js    # 兑换码系统
└── icons/                      # 图标资源
```

### 关键技术栈
- **前端框架**：原生JavaScript + Web Components
- **样式方案**：CSS3 + CSS Variables
- **构建工具**：Vite/Webpack
- **AI集成**：RESTful API调用
- **数据存储**：chrome.storage API
- **支付系统**：集成微信支付/支付宝二维码API
- **兑换码算法**：加密算法生成唯一兑换码
- **防刷机制**：IP限制 + 频率控制

## 开发里程碑

### 第一阶段：基础功能
- [ ] 插件框架搭建
- [ ] 基础目录生成
- [ ] 悬浮模式实现
- [ ] 基本UI界面

### 第二阶段：AI增强
- [ ] AI API集成
- [ ] 智能目录生成
- [ ] 用户密钥管理
- [ ] 性能优化

### 第三阶段：付费系统开发
- [ ] 使用次数统计系统
- [ ] 用户注册与身份识别
- [ ] 购买弹窗界面开发
- [ ] 二维码生成与更新机制
- [ ] 支付回调处理
- [ ] 兑换码系统后端
- [ ] 批量兑换码生成工具
- [ ] 防刷机制实现

### 第四阶段：高级功能
- [ ] 嵌入模式
- [ ] 个性化配置
- [ ] 站点适配
- [ ] 导出分享

### 第五阶段：完善体验
- [ ] 主题系统
- [ ] 快捷键支持
- [ ] 国际化
- [ ] 用户反馈系统

## 测试策略

### 功能测试
- [ ] 多站点兼容性测试
- [ ] 目录准确性验证
- [ ] AI生成功能测试
- [ ] 用户交互流程测试

### 性能测试
- [ ] 大页面处理性能
- [ ] 内存使用监控
- [ ] 响应时间测试
- [ ] 并发处理测试

### 安全测试
- [ ] 权限验证
- [ ] 数据加密验证
- [ ] XSS防护测试
- [ ] 注入攻击防护
- [ ] 支付安全测试
- [ ] 兑换码防破解测试
- [ ] 防刷机制验证

### 付费系统测试
- [ ] 使用次数统计准确性
- [ ] 购买流程完整性
- [ ] 兑换码验证机制
- [ ] 支付状态同步
- [ ] 异常情况处理

## 用户文档

### 快速开始
1. 从Chrome应用商店安装插件
2. 点击工具栏图标激活
3. 在任意文章页面查看自动生成的目录

### 高级配置
- 设置面板访问：右键图标 → 选项
- API密钥配置：设置 → AI服务 → 输入密钥
- 个性化调整：设置 → 外观与行为
- 购买与兑换：设置 → 账户与付费

### 故障排除
- 目录不显示：检查页面是否为文章类型
- AI功能异常：验证API密钥有效性
- 样式冲突：尝试切换主题或调整设置
- 使用次数不足：查看购买选项或输入兑换码
- 兑换码无效：检查兑换码是否正确或已使用
- 支付问题：联系客服或检查网络连接

## 后续规划

- **移动端支持**：开发Firefox/Safari版本
- **团队协作**：支持共享目录配置
- **API开放**：提供开发者API接口
- **机器学习优化**：基于用户行为优化目录生成算法
- **企业版本**：支持团队管理和批量授权
- **数据分析**：用户行为分析和商业智能报表